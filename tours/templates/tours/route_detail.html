{% extends "base.html" %}
{% block title %}Маршрут {{ route.name }}{% endblock %}

{% block extra_head %}{% endblock %}

{% block content %}
<h1>{{ route.name }}</h1>

<p>
  <a href="{% url 'route_print' route.pk %}" target="_blank">Печать / PDF</a>
</p>

<p>
  Дней: {{ route.days_count }}<br>
  Общее время: {{ route.total_duration_hours }} ч<br>
  Ориентировочная стоимость:
  {% if route.total_cost %}{{ route.total_cost }} ₽{% else %}—{% endif %}
</p>

<h2>Доступ по ссылке</h2>

<form method="post" action="{% url 'route_share_toggle' route.pk %}" style="margin-bottom:12px;">
  {% csrf_token %}
  <button type="submit">
    {% if route.is_shared %}Отключить доступ по ссылке{% else %}Включить доступ по ссылке{% endif %}
  </button>
</form>

{% if share_url %}
  <div style="margin-bottom:16px;">
    <div>Ссылка:</div>
    <a id="shareLink" href="{{ share_url }}" target="_blank">{{ share_url }}</a>
    <button type="button" onclick="navigator.clipboard.writeText('{{ share_url }}')">Копировать</button>
  </div>
{% endif %}

<h2>Добавить точку</h2>
<form method="post" action="{% url 'route_point_add' route.pk %}" style="margin-bottom:16px;">
  {% csrf_token %}
  {{ add_point_form.as_p }}
  <button type="submit">Добавить в маршрут</button>
</form>

<div id="map" style="height: 400px; margin-bottom: 24px;"></div>

{% for day, points in days.items %}
  <h2>День {{ day }}</h2>
  <ol>
    {% for p in points %}
      <li style="margin-bottom: 12px;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <strong>{{ p.poi.name }}</strong>
          <span>— планируется {{ p.visit_time_estimate }} ч</span>

          <form method="post" action="{% url 'route_point_move_up' route.pk p.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" {% if forloop.first %}disabled{% endif %}>↑</button>
          </form>

          <form method="post" action="{% url 'route_point_move_down' route.pk p.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" {% if forloop.last %}disabled{% endif %}>↓</button>
          </form>

          <form method="post" action="{% url 'route_point_delete' route.pk p.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" onclick="return confirm('Удалить точку из маршрута?')">Удалить</button>
          </form>
        </div>

        <div>{{ p.poi.short_description }}</div>
        {% if p.note %}<div><em>Примечание: {{ p.note }}</em></div>{% endif %}
      </li>
    {% endfor %}
  </ol>
{% empty %}
  <p>В этом маршруте пока нет точек.</p>
{% endfor %}

<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"></script>
<script>
    const pointsData = JSON.parse('{{ map_points_json|default:"[]"|escapejs }}');

    function init() {
        if (!pointsData.length) return;

        const coords = pointsData.map(p => [p.lat, p.lng]);
        const first = coords[0];

        const map = new ymaps.Map('map', {
            center: first,
            zoom: 7,
            controls: ['zoomControl']
        });

        pointsData.forEach(p => {
            const placemark = new ymaps.Placemark(
                [p.lat, p.lng],
                {
                    balloonContentHeader: 'День ' + p.day,
                    balloonContentBody: p.name
                },
                { preset: 'islands#blueCircleIcon' }
            );
            map.geoObjects.add(placemark);
        });

        const polyline = new ymaps.Polyline(coords, {}, { strokeWidth: 4 });
        map.geoObjects.add(polyline);

        const bounds = polyline.geometry.getBounds();
        if (bounds) {
            map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 20 });
        }
    }

    ymaps.ready(init);
</script>
{% endblock %}
