{% extends "base.html" %}
{% load timefmt %}

{% block title %}Маршрут {{ route.name }}{% endblock %}

{% block content %}
<style>
    @media print { .no-print { display: none !important; } }
</style>

<h1>{{ route.name }}</h1>

<p class="no-print">
    <a href="{% url 'route_print' route.pk %}" target="_blank">Печать / PDF</a>
</p>

<p>
    Дней: {{ route.days_count }}<br>
    Общее время: {{ route.total_duration_hours }} ч<br>
    Ориентировочная стоимость:
    {% if route.total_cost %}{{ route.total_cost }} ₽{% else %}—{% endif %}<br>

    {% if logistics_total_km %}
    В пути (оценка): ~{{ logistics_total_km|floatformat:1 }} км, ~{{ logistics_total_minutes|minutes_human }}
    {% endif %}
</p>

{% if route.equipment %}
<h2>Экипировка</h2>
<div style="white-space: pre-line;">{{ route.equipment }}</div>
{% endif %}

<h2>Доступ по ссылке</h2>

<form class="no-print" method="post" action="{% url 'route_share_toggle' route.pk %}" style="margin-bottom:12px;">
    {% csrf_token %}
    <button type="submit">
        {% if route.is_shared %}Отключить доступ по ссылке{% else %}Включить доступ по ссылке{% endif %}
    </button>
</form>

{% if share_url %}
<div class="no-print" style="margin-bottom:16px;">
    <div>Ссылка:</div>
    <a id="shareLink" href="{{ share_url }}" target="_blank">{{ share_url }}</a>
    <button type="button" onclick="navigator.clipboard.writeText('{{ share_url }}')">Копировать</button>
</div>
{% endif %}

<h2 class="no-print">Добавить точку</h2>
<form class="no-print" method="post" action="{% url 'route_point_add' route.pk %}" style="margin-bottom:16px;">
    {% csrf_token %}
    {{ add_point_form.as_p }}
    <button type="submit">Добавить в маршрут</button>
</form>

<form class="no-print" method="post" action="{% url 'route_optimize' route.pk %}" style="margin: 12px 0;">
  {% csrf_token %}
  <button type="submit">Оптимизировать порядок точек</button>
</form>

<div id="map" style="height: 400px; margin-bottom: 24px;"></div>

{% for b in day_blocks %}
<h2>
    День {{ b.day }}
    {% if b.distance_km %}
    — ~{{ b.distance_km|floatformat:1 }} км, ~{{ b.time_minutes|minutes_human }} в пути
    {% endif %}
</h2>

{% if b.points %}
<ol>
    {% for p in b.points %}
    <li style="margin-bottom: 12px;">
        <strong>{{ p.poi.name }}</strong> — {{ p.visit_time_estimate }} ч<br>
        {{ p.poi.short_description }}<br>
        {% if p.note %}<em>Примечание: {{ p.note }}</em><br>{% endif %}

        <div class="no-print" style="margin-top: 6px;">
            <form method="post" action="{% url 'route_point_move_up' route.pk p.pk %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit">↑</button>
            </form>

            <form method="post" action="{% url 'route_point_move_down' route.pk p.pk %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit">↓</button>
            </form>

            <form method="post" action="{% url 'route_point_delete' route.pk p.pk %}"
                  style="display:inline;"
                  onsubmit="return confirm('Удалить точку из маршрута?');">
                {% csrf_token %}
                <button type="submit">Удалить</button>
            </form>
        </div>
    </li>
    {% endfor %}
</ol>
{% else %}
<p>Точек на этот день нет.</p>
{% endif %}
{% empty %}
<p>В этом маршруте пока нет точек.</p>
{% endfor %}

<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"></script>
<script>
    const pointsData = JSON.parse('{{ map_points_json|default:"[]"|escapejs }}');

    function init() {
      if (!pointsData.length) return;

      const coords = pointsData.map(p => [p.lat, p.lng]);
      const first = coords[0];

      const map = new ymaps.Map('map', {
        center: first,
        zoom: 7,
        controls: ['zoomControl']
      });

      pointsData.forEach(p => {
        const placemark = new ymaps.Placemark(
          [p.lat, p.lng],
          { balloonContentHeader: 'День ' + p.day, balloonContentBody: p.name },
          { preset: 'islands#blueCircleIcon' }
        );
        map.geoObjects.add(placemark);
      });

      const polyline = new ymaps.Polyline(coords, {}, { strokeWidth: 4 });
      map.geoObjects.add(polyline);

      const bounds = polyline.geometry.getBounds();
      if (bounds) map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 20 });
    }

    ymaps.ready(init);
</script>
{% endblock %}
