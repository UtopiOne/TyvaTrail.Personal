{% extends "base.html" %}
{% load timefmt %}
{% block title %}Маршрут {{ route.name }}{% endblock %}

{% block content %}
<style>
  @media print { .no-print { display:none !important; } }
</style>

<div class="no-print" style="margin-bottom: 12px;">
  <button onclick="window.print()">Печать / Сохранить PDF</button>
</div>

<h1>{{ route.name }}</h1>

<p>
  Дней: {{ route.days_count }}<br>
  Общее время: {{ route.total_duration_hours }} ч<br>
  Ориентировочная стоимость:
  {% if route.total_cost %}{{ route.total_cost }} ₽{% else %}—{% endif %}<br>

  {% if logistics_total_km %}
    В пути (оценка): ~{{ logistics_total_km|floatformat:1 }} км, ~{{ logistics_total_minutes|minutes_human }}
  {% endif %}
</p>

{% if route.equipment %}
  <h2>Экипировка</h2>
  <div style="white-space: pre-line;">{{ route.equipment }}</div>
{% endif %}

<div id="map" style="height: 400px; margin-bottom: 24px;"></div>

{% if external_conditions.points %}
  <ul>
    {% for item in external_conditions.points %}
      <li>
        <strong>{{ item.point.poi.name }}</strong>:
        t={{ item.weather.temperature_c|default_if_none:"—" }}°C,
        ветер={{ item.weather.wind_speed_ms|floatformat:1|default:"—" }} м/с
        {% if item.place.opening_hours %} • часы: {{ item.place.opening_hours }}{% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p style="opacity:.7;">Пока нет данных по условиям.</p>
{% endif %}

{% for b in day_blocks %}
  <h2>
    День {{ b.day }}
    {% if b.distance_km %}
      — ~{{ b.distance_km|floatformat:1 }} км, ~{{ b.time_minutes|minutes_human }} в пути
    {% endif %}
  </h2>

  <ol>
    {% for p in b.points %}
      <li style="margin-bottom: 10px;">
        <strong>{{ p.poi.name }}</strong> — {{ p.visit_time_estimate }} ч<br>
        {{ p.poi.short_description }}<br>
        {% if p.note %}<em>Примечание: {{ p.note }}</em>{% endif %}
      </li>
    {% endfor %}
  </ol>
{% empty %}
  <p>В этом маршруте пока нет точек.</p>
{% endfor %}

<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"></script>
<script>
  const pointsData = JSON.parse('{{ map_points_json|default:"[]"|escapejs }}');

  function init() {
    if (!pointsData.length) return;

    const coords = pointsData.map(p => [p.lat, p.lng]);
    const first = coords[0];

    const map = new ymaps.Map('map', {
      center: first,
      zoom: 7,
      controls: ['zoomControl']
    });

    pointsData.forEach(p => {
      const placemark = new ymaps.Placemark(
        [p.lat, p.lng],
        { balloonContentHeader: 'День ' + p.day, balloonContentBody: p.name },
        { preset: 'islands#blueCircleIcon' }
      );
      map.geoObjects.add(placemark);
    });

    const polyline = new ymaps.Polyline(coords, {}, { strokeWidth: 4 });
    map.geoObjects.add(polyline);

    const bounds = polyline.geometry.getBounds();
    if (bounds) map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 20 });
  }

  ymaps.ready(init);
</script>
{% endblock %}
