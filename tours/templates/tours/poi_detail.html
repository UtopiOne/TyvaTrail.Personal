{% extends "base.html" %}
{% load django_bootstrap5 %}
{% block title %}
{{ poi.name }}
{% endblock title %}
{% block extra_head %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"></script>
<script>
  const mapPoint = JSON.parse('{{ map_point_json|escapejs }}');

  function init() {
    const map = new ymaps.Map('map', {
      center: [mapPoint.lat, mapPoint.lng],
      zoom: 10,
      controls: ['zoomControl']
    });

    const placemark = new ymaps.Placemark([mapPoint.lat, mapPoint.lng], {
      balloonContentBody: mapPoint.name
    });
    map.geoObjects.add(placemark);
  }

  ymaps.ready(init);
</script>
{% endblock extra_head %}
{% block content %}
<style>
  #map {
    width: 450px;
    height: 500px;
  }

  @media (max-width: 990px) {
    #map {
      width: 100%;
    }
  }
</style>

<div class="m-4">
  <div class="d-flex justify-content-between flex-column flex-lg-row">
    <div class="m-8">
      <h1>{{ poi.name }}</h1>
      <p>{{ poi.short_description }}</p>
      {% if poi.detailed_description %}<p>{{ poi.detailed_description }}</p>{% endif %}
      <p>
        Рейтинг:
        {% if poi.avg_rating %}
        {{ poi.avg_rating|floatformat:1 }}/5
        {% else %}
        —
        {% endif %}
      </p>
      <p>Тип: {{ poi.get_type_display }}</p>
      {% if poi.region %}<p>Регион: {{ poi.region }}</p>{% endif %}
      <p>Сезон: {{ poi.get_season_display }}</p>
      <p>Сложность: {{ poi.get_physical_level_display }}</p>
      <p>
        Цены: {{ poi.get_price_level_display }}
        {% if poi.base_cost %}(~{{ poi.base_cost }} ₽){% endif %}
      </p>
      {% if poi.address %}<p>Адрес: {{ poi.address }}</p>{% endif %}
      {% if poi.access_info %}<p>Как добраться: {{ poi.access_info }}</p>{% endif %}
    </div>
    <div class="flex-shrink-0 ml-8">
      {% if map_point_json %}
      <div id="map"></div>
      {% else %}
      <p>
        <em>Координаты не указаны — карта недоступна.</em>
      </p>
      {% endif %}
    </div>
  </div>
  <h2>Фотографии</h2>
  <div>
    <div class="row">
      {% for ph in photos %}
      <div class="col-lg-4 mb-4">
        <figure class="figure">
          <img class="figure-img img-thumbnail rounded" src="{{ ph.image_url }}"
            alt="{{ ph.caption|default:"Фото" }}" />
          <figcaption class="figure-caption text-center">{{ ph.caption|default:"Фото" }}</figcaption>
        </figure>
      </div>
      {% empty %}
      <p class="text-muted text-start">Фото пока нет.</p>
    </div>
    {% endfor %}
  </div>
  <h2>
    {% if user_review %}
    Редактировать отзыв
    {% else %}
    Оставить отзыв
    {% endif %}
  </h2>
  {% if user.is_authenticated %}
  <form method="post">
    {% csrf_token %}
    {% bootstrap_form review_form layout="horizontal" %}
    {% bootstrap_button button_class="btn-success" button_type="submit" content="Отправить" %}
  </form>
  {% else %}
  <p>
    Чтобы оставить отзыв, нужно <a href="{% url 'login' %}">войти</a>.
  </p>
  {% endif %}
  <h2>Отзывы</h2>
  <ul class="list-unstyled">
    {% for r in reviews %}
    <li class="card">
      <div class="card-body">
        <p class="h5 card-title">
          <strong>{{ r.user.username }}</strong> — {{ r.rating }}/5
        </p>
        {{ r.text|default:"(без текста)" }}
      </div>
      <div class="card-footer">
        <p class="text-muted">Выложено {{ r.created_at|date:"d.m.Y" }}</p>
      </div>
    </li>
    {% empty %}
    <li>Отзывов пока нет.</li>
    {% endfor %}
  </ul>
  <p>
    <a class="btn btn-primary" href="{% url 'poi_list' %}">← Назад в каталог</a>
  </p>
</div>
{% endblock content %}